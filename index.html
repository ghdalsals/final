<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>수학 문제집/강좌 추천</title>
</head>
<body>
  <h1>수학 문제집 추천</h1>

  <div>
    <p>
      <label>어떤 과목에 대한 추천을 원하시나요?
        <select id="track">
          <option value="">선택</option>
          <option value="수1">수1</option>
          <option value="수2">수2</option>
          <option value="미적">미적</option>
          <option value="확통">확통</option>
          <option value="기하">기하</option>
        </select>
      </label>
    </p>

    <p>
      <label>인강을 들으실 건가요, 아니면 자습으로 진행하실 건가요?
        <select id="mode">
          <option value="">선택</option>
          <option value="인강">인강</option>
          <option value="자습">자습</option>
        </select>
      </label>
    </p>

    <p>
      <label>9월 모의고사 수학 점수는 몇 점이었나요?
        <input id="scoreNum" type="number" min="0" max="100" step="1" />
      </label>
    </p>

    <p>
      <label>점수 조절
        <input id="score" type="range" min="0" max="100" step="1" value="100" />
      </label>
      <span>현재: <b id="scoreVal">100</b>점</span>
    </p>

    <p>
      <label>하루에 수학 공부를 몇 시간 정도 하실 계획인가요?
        <select id="hours">
          <option value="">선택</option>
          <option value="1">1시간</option>
          <option value="2">2시간</option>
          <option value="3">3시간</option>
          <option value="4">4시간 이상</option>
        </select>
      </label>
    </p>

    <p>
      <label>본인이 어떤 부분이 부족한지(개념/기출/준킬러 등) 구체적으로 알고 계신가요?
        <select id="aware">
          <option value="">선택</option>
          <option value="예">예</option>
          <option value="아니오">아니오</option>
        </select>
      </label>
    </p>

    <button id="go">결과 보기</button>

    <p id="err" style="color:#b00020;"></p>
  </div>

  <hr />

  <h2>추천 결과</h2>
  <pre id="result"></pre>
  <p id="saveStatus"></p>

  <!-- CORS 회피용: 숨김 iframe + form POST -->
  <iframe name="logFrame" style="display:none;"></iframe>
  <form id="logForm" method="POST" target="logFrame">
    <input type="hidden" name="payload" id="payloadField" />
  </form>

  <script>
    // Google Apps Script 웹앱 URL (/exec)
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwhbUxiepNBW-MEA7ifhATnEs_gsPB2dO9tUZVrUf1xnllYQ6rG4zEgIPkEGJ65RlA6wQ/exec";

    const BASE_SETS = {
      "50|인강": ["세젤쉬", "파운데이션", "개때잡", "시발점"],
      "50|자습": ["한완수", "개념완성", "마플시너지", "쏀", "수특수완"],

      "60|인강": ["파운데이션", "시발점", "개때잡"],
      "60|자습": ["한완수", "쏀", "마플시너지", "한완기"],

      "72|인강": ["시발점", "아이디어", "미친기본-시작편"],
      "72|자습": ["팔구십퍼요", "시빌리삼", "싱글커넥션", "N티켓"],

      "84|인강": ["뉴런", "미친개념", "아이디어", "수분감", "알파테크닉"],
      "84|자습": ["한완수", "한완기", "수분감", "자이스토리", "마더텅", "어삼쉬사"],

      "92|인강": ["뉴런", "미친개념", "아이디어", "드릴", "수분감", "미친기본-완성편"],
      "92|자습": ["이해원 N제", "설레임", "4의 규칙", "드릴"],

      "92+|인강": ["드릴", "드릴드", "뉴런", "미친기본-완성편"],
      "92+|자습": ["4의 규칙", "샤인미 N제", "설맞이", "자이스토리", "수특수완"]
    };

    const $ = (id) => document.getElementById(id);
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const uniq = (arr) => [...new Map(arr.map(x => [x, true])).keys()];

    function bucketScore(scoreNorm4) {
      if (scoreNorm4 <= 50) return "50";
      if (scoreNorm4 <= 60) return "60";
      if (scoreNorm4 <= 72) return "72";
      if (scoreNorm4 <= 84) return "84";
      if (scoreNorm4 <= 92) return "92";
      return "92+";
    }

    function applyFilters(hours, list) {
      const h = Number(hours);
      let out = [...list];

      if (h === 1) {
        const remove = new Set(["자이스토리", "마더텅", "시발점", "뉴런"]);
        out = out.filter(x => !remove.has(x));
      }
      if (h === 2) out = out.slice(0, 2);
      if (h === 3) {
        const remove = new Set(["자이스토리", "마더텅"]);
        out = out.filter(x => !remove.has(x));
        if (!out.includes("수분감")) out.push("수분감");
      }
      return uniq(out);
    }

    function applyAwareness(modeEffective, aware, list) {
      let out = [...list];
      if (aware === "예") return out;

      if (modeEffective === "자습") {
        if (!out.includes("한완기")) out.unshift("한완기");
        if (!out.includes("한완수")) out.unshift("한완수");
      }
      return uniq(out);
    }

    function recommend(input) {
      const bucket = bucketScore(input.score_norm4);

      // 1시간 + 인강 => 자습 전환
      let mode_effective = input.mode_input;
      if (Number(input.hours) === 1 && input.mode_input === "인강") {
        mode_effective = "자습";
      }

      const base = BASE_SETS[`${bucket}|${mode_effective}`] || [];
      let list = applyFilters(input.hours, base);
      list = applyAwareness(mode_effective, input.aware, list);

      return { bucket, mode_effective, list };
    }

    function render(list) {
      $("result").textContent = list.map((x, i) => `${i + 1}. ${x}`).join("\n");
    }

    function saveToSheet(payloadObj) {
      if (!GAS_ENDPOINT || GAS_ENDPOINT.includes("PASTE_YOUR_GAS_WEBAPP_URL_HERE")) {
        $("saveStatus").textContent = "저장 실패: GAS_ENDPOINT가 설정되지 않았습니다.";
        return;
      }
      const form = $("logForm");
      form.action = GAS_ENDPOINT;
      $("payloadField").value = JSON.stringify(payloadObj);
      form.submit();
    }

    // ✅ (정리) 기기 고유 ID: 클릭 이벤트 밖에서 1번만 정의
    function getDeviceId() {
      let id = localStorage.getItem("device_id");
      if (!id) {
        id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "-" + Math.random()));
        localStorage.setItem("device_id", id);
      }
      return id;
    }

    // 숫자 입력 <-> 슬라이더 동기화
    function syncFromRange() {
      $("scoreVal").textContent = $("score").value;
      $("scoreNum").value = $("score").value;
    }
    function syncFromNumber() {
      const v = clamp(Number($("scoreNum").value), 0, 100);
      $("score").value = String(v);
      $("scoreVal").textContent = String(v);
    }
    $("score").addEventListener("input", syncFromRange);
    $("scoreNum").addEventListener("input", syncFromNumber);
    syncFromRange();

    $("go").addEventListener("click", () => {
      $("err").textContent = "";
      $("saveStatus").textContent = "";

      const track = $("track").value;
      const mode_input = $("mode").value;
      const hours = $("hours").value;
      const aware = $("aware").value;

      let score_raw = Number($("score").value);
      if (!track || !mode_input || !hours || !aware || !Number.isFinite(score_raw)) {
        $("err").textContent = "모든 항목을 선택/입력해 주세요.";
        return;
      }

      // 100 이하만 강제(하한은 0으로 처리)
      score_raw = clamp(score_raw, 0, 100);

      // 내부 4점 단위 정규화 (사용자 입력은 그대로 유지)
      const score_norm4 = clamp(Math.round(score_raw / 4) * 4, 0, 100);

      const input = { track, mode_input, hours, aware, score_raw, score_norm4 };
      const rec = recommend(input);

      render(rec.list);

      // ✅ (정리) payload는 여기서만 생성
      const payload = {
        input,
        result: rec,
        deviceId: getDeviceId(),
        ua: navigator.userAgent
      };

      saveToSheet(payload);
    });
  </script>
</body>
</html>
