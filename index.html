<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>수학 문제집/강좌 추천</title>
</head>
<body>
  <h1>수학 문제집 추천</h1>

  <div>
    <p>
      <label>어떤 과목에 대한 추천을 원하시나요?
        <select id="track">
          <option value="">선택</option>
          <option value="수1">수1</option>
          <option value="수2">수2</option>
          <option value="미적">미적</option>
          <option value="확통">확통</option>
          <option value="기하">기하</option>
        </select>
      </label>
    </p>

    <p>
      <label>인강을 들으실 건가요, 아니면 자습으로 진행하실 건가요?
        <select id="mode">
          <option value="">선택</option>
          <option value="인강">인강</option>
          <option value="자습">자습</option>
        </select>
      </label>
    </p>

    <!-- ✅ 점수 입력: 표준점수 다중 입력 -->
    <div style="margin: 12px 0;">
      <div style="display:flex; align-items:center; gap:8px;">
        <b>표준점수 입력</b>
        <button id="addScore" type="button">+ 점수 추가</button>
      </div>

      <div id="scores" style="margin-top:8px;"></div>
      <small style="color:#555;">
        여러 회차 점수를 입력하면 평균을 기준으로 추천합니다.
      </small>
    </div>

    <p>
      <label>하루에 수학 공부를 몇 시간 정도 하실 계획인가요?
        <select id="hours">
          <option value="">선택</option>
          <option value="1">1시간</option>
          <option value="2">2시간</option>
          <option value="3">3시간</option>
          <option value="4">4시간 이상</option>
        </select>
      </label>
    </p>

    <p>
      <label>본인이 어떤 부분이 부족한지 구체적으로 알고 계신가요?
        <select id="aware">
          <option value="">선택</option>
          <option value="예">예</option>
          <option value="아니오">아니오</option>
        </select>
      </label>
    </p>

    <button id="go" type="button">결과 보기</button>

    <p id="err" style="color:#b00020;"></p>
  </div>

  <hr />

  <h2>추천 결과</h2>
  <pre id="result"></pre>
  <p id="saveStatus"></p>

  <!-- CORS 회피용: 숨김 iframe + form POST -->
  <iframe name="logFrame" style="display:none;"></iframe>
  <form id="logForm" method="POST" target="logFrame">
    <input type="hidden" name="payload" id="payloadField" />
  </form>

  <script>
    // Google Apps Script 웹앱 URL (/exec)
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwhbUxiepNBW-MEA7ifhATnEs_gsPB2dO9tUZVrUf1xnllYQ6rG4zEgIPkEGJ65RlA6wQ/exec";

    const BASE_SETS = {
      "50|인강": ["세젤쉬", "파운데이션", "개때잡", "시발점"],
      "50|자습": ["한완수", "개념완성", "마플시너지", "쏀", "수특수완"],

      "60|인강": ["파운데이션", "시발점", "개때잡"],
      "60|자습": ["한완수", "쏀", "마플시너지", "한완기"],

      "72|인강": ["시발점", "아이디어", "미친기본-시작편"],
      "72|자습": ["팔구십퍼요", "시빌리삼", "싱글커넥션", "N티켓"],

      "84|인강": ["뉴런", "미친개념", "아이디어", "수분감", "알파테크닉"],
      "84|자습": ["한완수", "한완기", "수분감", "자이스토리", "마더텅", "어삼쉬사"],

      "92|인강": ["뉴런", "미친개념", "아이디어", "드릴", "수분감", "미친기본-완성편"],
      "92|자습": ["이해원 N제", "설레임", "4의 규칙", "드릴"],

      "92+|인강": ["드릴", "드릴드", "뉴런", "미친기본-완성편"],
      "92+|자습": ["4의 규칙", "샤인미 N제", "설맞이", "자이스토리", "수특수완"]
    };

    const $ = (id) => document.getElementById(id);
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const uniq = (arr) => [...new Map(arr.map(x => [x, true])).keys()];

    // ✅ 표준점수 구간 설정 (너희 기준에 맞게 숫자만 바꾸면 됨)
    // 예: 평균 표준점수가 100 이하면 50, 110 이하면 60 ... 이런 식
    const STD_BUCKET_CUTS = [
      { max: 100, bucket: "50" },
      { max: 110, bucket: "60" },
      { max: 120, bucket: "72" },
      { max: 130, bucket: "84" },
      { max: 140, bucket: "92" },
      { max: Infinity, bucket: "92+" }
    ];

    function bucketByStd(avgStdScore) {
      for (const cut of STD_BUCKET_CUTS) {
        if (avgStdScore <= cut.max) return cut.bucket;
      }
      return "92+";
    }

    function applyFilters(hours, list) {
      const h = Number(hours);
      let out = [...list];

      if (h === 1) {
        const remove = new Set(["자이스토리", "마더텅", "시발점", "뉴런"]);
        out = out.filter(x => !remove.has(x));
      }
      if (h === 2) out = out.slice(0, 2);
      if (h === 3) {
        const remove = new Set(["자이스토리", "마더텅"]);
        out = out.filter(x => !remove.has(x));
        if (!out.includes("수분감")) out.push("수분감");
      }
      return uniq(out);
    }

    function applyAwareness(modeEffective, aware, list) {
      let out = [...list];
      if (aware === "예") return out;

      if (modeEffective === "자습") {
        if (!out.includes("한완기")) out.unshift("한완기");
        if (!out.includes("한완수")) out.unshift("한완수");
      }
      return uniq(out);
    }

    function recommend(input) {
      const bucket = bucketByStd(input.score_avg);

      // 1시간 + 인강 => 자습 전환
      let mode_effective = input.mode_input;
      if (Number(input.hours) === 1 && input.mode_input === "인강") {
        mode_effective = "자습";
      }

      const base = BASE_SETS[`${bucket}|${mode_effective}`] || [];
      let list = applyFilters(input.hours, base);
      list = applyAwareness(mode_effective, input.aware, list);

      return { bucket, mode_effective, list };
    }

    function render(list) {
      $("result").textContent = list.map((x, i) => `${i + 1}. ${x}`).join("\n");
    }

    function saveToSheet(payloadObj) {
      if (!GAS_ENDPOINT || GAS_ENDPOINT.includes("PASTE_YOUR_GAS_WEBAPP_URL_HERE")) {
        $("saveStatus").textContent = "저장 실패: GAS_ENDPOINT가 설정되지 않았습니다.";
        return;
      }
      const form = $("logForm");
      form.action = GAS_ENDPOINT;
      $("payloadField").value = JSON.stringify(payloadObj);
      form.submit();
    }

    // 기기 고유 ID
    function getDeviceId() {
      let id = localStorage.getItem("device_id");
      if (!id) {
        id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "-" + Math.random()));
        localStorage.setItem("device_id", id);
      }
      return id;
    }

    // ✅ 점수 입력칸(행) 생성/삭제
    function makeScoreRow(initialValue = "") {
      const row = document.createElement("div");
      row.className = "scoreRow";
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.gap = "8px";
      row.style.margin = "6px 0";

      const input = document.createElement("input");
      input.type = "number";
      input.className = "scoreInput";
      input.placeholder = "표준점수";
      input.min = "0";
      input.max = "200";
      input.step = "1";
      input.value = initialValue;

      const del = document.createElement("button");
      del.type = "button";
      del.textContent = "삭제";
      del.addEventListener("click", () => {
        const wrap = $("scores");
        // 최소 1개는 남기기
        if (wrap.querySelectorAll(".scoreRow").length <= 1) return;
        row.remove();
      });

      row.appendChild(input);
      row.appendChild(del);
      return row;
    }

    function getScores() {
      const inputs = [...document.querySelectorAll(".scoreInput")];
      const nums = inputs
        .map(el => Number(el.value))
        .filter(v => Number.isFinite(v));

      // 0~200 범위 클램프
      return nums.map(v => clamp(v, 0, 200));
    }

    function average(arr) {
      if (!arr.length) return NaN;
      return arr.reduce((a, b) => a + b, 0) / arr.length;
    }

    // 초기 점수 1개 생성
    $("scores").appendChild(makeScoreRow(""));

    $("addScore").addEventListener("click", () => {
      $("scores").appendChild(makeScoreRow(""));
    });

    $("go").addEventListener("click", () => {
      $("err").textContent = "";
      $("saveStatus").textContent = "";

      const track = $("track").value;
      const mode_input = $("mode").value;
      const hours = $("hours").value;
      const aware = $("aware").value;

      const scores = getScores();
      if (!track || !mode_input || !hours || !aware) {
        $("err").textContent = "모든 항목을 선택해 주세요.";
        return;
      }
      if (scores.length === 0) {
        $("err").textContent = "표준점수를 최소 1개 이상 입력해 주세요.";
        return;
      }

      const score_avg = average(scores);
      if (!Number.isFinite(score_avg)) {
        $("err").textContent = "표준점수 입력값을 확인해 주세요.";
        return;
      }

      const input = { track, mode_input, hours, aware, scores, score_avg };
      const rec = recommend(input);

      render(rec.list);

      const payload = {
        input,
        result: rec,
        deviceId: getDeviceId(),
        ua: navigator.userAgent
      };

      saveToSheet(payload);
    });
  </script>
</body>
</html>
